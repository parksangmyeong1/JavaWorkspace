<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	 
<!-- 인터페이스의 full name을 namespace로 설정 -->
<mapper namespace="com.bitcamp.cobsp.post.dao.Dao">
	
	<!-- select의 결과를 매핑하는 설정 -->
	<resultMap id="postListResult" 
		type="com.bitcamp.cobsp.post.domain.Post">
		<id column="postIdx" property="postIdx"/>
		<result column="memIdx" property="memIdx"/>
		<result column="postWriter" property="postWriter"/>
		<result column="postSort" property="postSort"/>
		<result column="postContent" property="postContent"/>
		<result column="postRegDate" property="postRegDate"/>
		<result column="views" property="views"/>
		<result column="postLike" property="postLike"/>
		<result column="postDislike" property="postDislike"/>
		<result column="postRep" property="postRep"/>
	</resultMap>
	
	<resultMap id="commListResult" 
		type="com.bitcamp.cobsp.comment.domain.Comment">
		<id column="commIdx" property="commIdx"/>
		<result column="postIdx" property="postIdx"/>
		<result column="commWriter" property="commWriter"/>
		<result column="commContent" property="commContent"/>
		<result column="commRegDate" property="commRegDate"/>
		<result column="commLike" property="commLike"/>
		<result column="commDislike" property="commDislike"/>
		<result column="commRep" property="commRep"/>
	</resultMap>
	
	<resultMap id="recommListResult" 
		type="com.bitcamp.cobsp.recomment.domain.Recomment">
		<id column="recommIdx" property="recommIdx"/>
		<result column="commIdx" property="commIdx"/>
		<result column="recommWriter" property="recommWriter"/>
		<result column="recommContent" property="recommContent"/>
		<result column="recommRegDate" property="recommRegDate"/>
		<result column="recommLike" property="recommLike"/>
		<result column="recommDislike" property="recommDislike"/>
		<result column="recommRep" property="recommRep"/>
	</resultMap>
	
	<!-- 게시글 등록 -->
	<insert id="insertPost"
		parameterType="com.bitcamp.cobsp.post.domain.Post"
		useGeneratedKeys="true"
		keyProperty="postIdx">
		insert into post (memIdx, postWriter, postTitle, postContent, postSort)
		value (#{memIdx}, #{postWriter}, #{postTitle}, #{postContent}, #{postSort})
	</insert>
	
	<!-- 게시글 리스트 출력 -->
	<select id="selectAll"
		resultMap="postListResult">
		select * from post order by postIdx desc
	</select>
	
	<!-- 게시글 수정 -->
	<update id="editPost"
		parameterType="com.bitcamp.cobsp.post.domain.Post">
		update post set postSort = #{postSort}, postTitle = #{postTitle}, postContent = #{postContent} where postIdx = #{postIdx}
	</update>
	
	<!-- 게시글 삭제 -->
	<delete id="deletePost">
		delete from post where postIdx = #{postIdx}
	</delete>
	
	<!-- 해당 게시글 출력 -->
	<select id="selectPostDetail" resultMap="postListResult">
	<![CDATA[
		select * from post where postIdx IN (
          ( SELECT postIdx FROM post WHERE postIdx < #{postIdx} ORDER BY postIdx DESC LIMIT 1 ),
          ( SELECT postIdx FROM post WHERE postIdx = #{postIdx} ),
          ( SELECT postIdx FROM post WHERE postIdx > #{postIdx} ORDER BY postIdx LIMIT 1)
       )
       ]]>
	</select>
	
	<!-- 수정할 게시글 가져오기 -->
	<select id="selectByIdx" resultMap="postListResult"> 
		select * from post where postIdx = #{postIdx}
	</select>
	
	<!-- 댓글 등록 -->
	<insert id="insertComment"
		parameterType="com.bitcamp.cobsp.comment.domain.Comment"
		useGeneratedKeys="true"
		keyProperty="commIdx">
		insert into comment (postIdx, memIdx, commContent)
		value (#{postIdx}, #{memIdx}, #{commContent})
	</insert>	
	
	<!-- 댓글 조회 -->
	<select id="selectCommList"
		resultMap="commListResult">
		select c.*, m.nickName as commWriter from comment c, member1 m 
		where postIdx=#{postIdx} and m.memIdx = c.memIdx order by commIdx;
	</select>
	
	<delete id="deleteComment">
		delete from comment where commIdx = #{commIdx}
	</delete>
	
	<!-- 댓글 수정 -->
	<update id="editComment">
		update comment set commContent = #{param2} where commIdx = #{param1}
	</update>
	
	<!-- 조회수 증가 -->
	<update id="addViews">
		update post set views = views + 1 where postIdx = #{postIdx};
	</update>
	
	<!-- 댓글 수 조회 -->
	<select id="countComment"
		resultType="int">
		select count(*) from comment where postIdx = #{postIdx};
	</select>
	
	<!-- 게시글 좋아요 증가 -->
	<update id="addLike">
		update post set postLike = postLike + 1  where postIdx = #{postIdx}; 
	</update>
	
	<!-- 게시글 좋아요 증가 -->
	<update id="addDislike">
		update post set postDislike = postDislike + 1  where postIdx = #{postIdx}; 
	</update>
	
	<!-- 게시글  신고하기 -->
	<update id="addRep">
		update post set postRep = postRep + 1  where postIdx = #{postIdx}; 
	</update>
	
	<!-- 게시글의 총 갯수 -->
	<select id="countPost" resultType="int">
		<if test="!(postSort!=null and postSort!='')">
			select count(*) from post;
		</if>
		<if test="postSort!=null and postSort!=''">
			select count(*) from post where postSort = #{postSort};
		</if>
	</select>
	
	<!-- 게시글 페이징 -->
	<select id="pagingPost"
		resultMap="postListResult">
		select * from post order by postIdx desc limit #{start}, #{cntPerPage};
	</select>
	
	<!-- 카테고리 + 페이징 게시글 페이징 -->
	<select id="selectBySAP"
		resultMap="postListResult">
		select * from post where postSort = #{param1} order by postIdx desc limit #{param2.start}, #{param2.cntPerPage};
	</select>
	
	<select id="selectBySearch"
		parameterType="com.bitcamp.cobsp.post.domain.SearchType"
		resultType="com.bitcamp.cobsp.post.domain.Post"> 
		select * from post
		<where>
			<if test="searchType=='both'">
				postWriter like concat('%', #{keyword}, '%') 
				or postContent like concat('%', #{keyword}, '%')
			</if>
			<if test="searchType=='title'">
				postTitle like concat('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='content'">
				postContent like concat('%', #{keyword}, '%') 
			</if>
			<if test="searchType=='nickName'">
				postWriter like concat('%', #{keyword}, '%') 
			</if>
		</where>
	</select>
	
	<select id="selectBySearch1"
		parameterType="java.util.HashMap"
		resultMap="postListResult"> 
		select * from post 
		<where>
			<if test="item1.searchType=='both'">
				postTitle like concat('%', #{item1.keyword}, '%') 
				or postContent like concat('%', #{item1.keyword}, '%')
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
			<if test="item1.searchType=='title'">
				postTitle like concat('%', #{item1.keyword}, '%') 
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
			<if test="item1.searchType=='content'">
				postContent like concat('%', #{item1.keyword}, '%') 
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
			<if test="item1.searchType=='nickName'">
				postWriter like concat('%', #{item1.keyword}, '%') 
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
		</where>
	</select>
	
	<select id="selectBySearchAndPaging"
		parameterType="java.util.HashMap"
		resultMap="postListResult"> 
		select * from post 
		<where>
			<if test="item1.searchType=='both'">
				postSort = #{postSort} and (postTitle like concat('%', #{item1.keyword}, '%') 
				or postContent like concat('%', #{item1.keyword}, '%'))
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
			<if test="item1.searchType=='title'">
				postSort = #{postSort} and postTitle like concat('%', #{item1.keyword}, '%') 
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
			<if test="item1.searchType=='content'">
				postSort = #{postSort} and postContent like concat('%', #{item1.keyword}, '%') 
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
			<if test="item1.searchType=='nickName'">
				postSort = #{postSort} and postWriter like concat('%', #{item1.keyword}, '%') 
				order by postIdx desc limit #{item2.start}, #{item2.cntPerPage}
			</if>
		</where>
	</select>
	
	<!-- 댓글 추천 -->
	<update id="addCommLike"
		parameterType="int">
		update comment set commLike = commLike + 1 where commIdx = #{commIdx}
	</update>
	
	<!-- 댓글 비추천 -->
	<update id="addCommDislike"
		parameterType="int">
		update comment set commDislike = commDislike + 1 where commIdx = #{commIdx}
	</update>
	
	<!-- 댓글  신고하기 -->
	<update id="addCommRep">
		update comment set commRep = commRep + 1  where commIdx = #{commIdx}; 
	</update>
	
	<select id="selectDislike"
		parameterType="int"
		resultType="int">
		select commDislike from comment where commIdx = #{commIdx}
	</select>
	
	
	<insert id="insertRecomment"
		parameterType="com.bitcamp.cobsp.recomment.domain.Recomment"
		useGeneratedKeys="true"
		keyProperty="recommIdx">
		insert into recomment (postIdx, commIdx, memIdx, recommContent)
		value (#{postIdx}, #{commIdx}, #{memIdx}, #{recommContent})
	</insert>
	
	<select id="selectRecommList"
		resultMap="recommListResult">
		select r.*, m.nickName as recommWriter from recomment r, member1 m 
		where postIdx = #{postIdx} and m.memIdx = r.memIdx;
	</select>
	
	<select id="selectBestComment"
		resultMap="commListResult">
		select c.*,m.nickName as commWriter 
		from comment c, member1 m where postIdx = #{postIdx} and m.memIdx=c.memIdx 
		order by commLike desc limit 1
	</select>
	
	<delete id="deleteRecomment">
		delete from recomment where recommIdx = #{recommIdx}
	</delete>
	
	<!-- 댓글 수정 -->
	<update id="editRecomment">
		update recomment set recommContent = #{param2} where recommIdx = #{param1}
	</update>
	
	<!-- 대댓글 좋아요 증가 -->
	<update id="addRecommLike">
		update recomment set recommLike = recommLike + 1  where recommIdx = #{recommIdx}; 
	</update>
	
	<!-- 대댓글 싫어요 증가 -->
	<update id="addRecommDislike">
		update recomment set recommDislike = recommDislike + 1  where recommIdx = #{recommIdx}; 
	</update>
	
	<!-- 대댓글  신고 증가 -->
	<update id="addRecommRep">
		update recomment set recommRep = recommRep + 1  where recommIdx = #{recommIdx}; 
	</update>
	
	<insert id="insertCheck">
		insert into checklike (type, tableType, idx, memIdx)
		values (#{type}, #{tableType}, #{idx}, #{memIdx})
	</insert>
	
	<select id="selectLikeCheck"
		resultType="int">
		select count(*) from checklike 
		where type=#{type} and tableType=#{tableType} and idx=#{idx} and memIdx=#{memIdx}
	</select>
</mapper>